query: |
  with customers as (

    select * from `catalog.jaffle_shop.stg_customers` 
  
  ),
  
  orders as (
  
  select * from `catalog.jaffle_shop.stg_orders` 
  
  ),
  
  payments as (
  
  select * from `catalog.jaffle_shop.stg_payments` 
  
  ),
  
  customer_orders as (
  
  select
  customer_id,
  
  min(order_date) as first_order,
  max(order_date) as most_recent_order,
  count(order_id) as number_of_orders
  from orders
  
  group by customer_id
  
  ),
  
  customer_payments as (
  
  select
  orders.customer_id,
  sum(amount) as total_amount
  
  from payments
  
  left join orders on
  payments.order_id = orders.order_id
  
  group by orders.customer_id
  
  ),
  
  final as (
  
  select
  customers.customer_id,
  customers.first_name,
  customers.last_name,
  customer_orders.first_order,
  customer_orders.most_recent_order,
  customer_orders.number_of_orders,
  customer_payments.total_amount as customer_lifetime_value
  
  from customers
  
  left join customer_orders
  on customers.customer_id = customer_orders.customer_id
  
  left join customer_payments
  on  customers.customer_id = customer_payments.customer_id
  
  ), groupby AS(
    select customer_id,first_name,
    SUM(customer_lifetime_value) AS total_customer_lifetime_value
  FROM final
  where first_order is not null
  GROUP BY GROUPING SETS (customer_id, first_name)
  ), final_no_limit AS(

  select customer_id,first_name,total_customer_lifetime_value
  from groupby
  ORDER BY 1
  )
  select * from final_no_limit
    ORDER BY 2
  LIMIT 12

expected_output:
  name: "customers"
  output_columns:
    - name: "customer_id"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_customers"
          name: "customer_id"
    - name: "first_name"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_customers"
          name: "first_name"
    - name: "total_customer_lifetime_value"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_payments"
          name: "amount"
  other_scanned_columns:
    - name: "_first_name_"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_customers"
          name: "first_name"
    - name: "_customer_id_"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_customers"
          name: "customer_id"
    - name: "_first_order_"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_orders"
          name: "order_date"
    - name: "_customer_id_"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_orders"
          name: "customer_id"
    - name: "_order_id_"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_orders"
          name: "order_id"
    - name: "_order_id_"
      references:
        - project_name: "catalog"
          dataset_name: "jaffle_shop"
          table_name: "stg_payments"
          name: "order_id"
  type: "select"
  selected_tables:
    - "catalog.jaffle_shop.stg_orders"
    - "catalog.jaffle_shop.stg_customers"
    - "catalog.jaffle_shop.stg_payments"


